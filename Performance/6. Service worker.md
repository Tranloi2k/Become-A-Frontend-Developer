# Service Worker là gì? Hướng dẫn chi tiết

**Tác giả:** @Tranloi2k  
**Ngày tạo:** 2025-09-24  
**Mô tả:** Giải thích về Service Worker, cách hoạt động, ví dụ thực tế và làm rõ về cơ chế cache trong Service Worker.

---

## 1. Service Worker là gì?

**Service Worker** là một script JavaScript chạy ngầm phía sau (background) của trình duyệt, tách biệt với luồng chính của trang web. Service Worker có thể can thiệp vào các request mạng, cache dữ liệu, gửi push notification, và cho phép web hoạt động offline.

---

## 2. Tính năng nổi bật của Service Worker

- **Intercept & xử lý request mạng:** Bạn có thể kiểm soát, thay đổi, trả về cache hoặc fetch mới cho mọi request từ trang web.
- **Offline Support:** Cho phép web/app vẫn hoạt động khi mất kết nối internet (bằng việc sử dụng cache).
- **Push Notification:** Gửi thông báo từ server đến client ngay cả khi app không mở.
- **Background Sync:** Thực hiện đồng bộ hóa dữ liệu khi kết nối mạng trở lại.
- **Tiền đề cho Progressive Web App (PWA):** Service Worker là thành phần bắt buộc để web có thể cài lên home screen, offline, push...

---

## 3. Cơ chế cache của Service Worker

### a. Cache là gì?

Cache ở đây là bộ nhớ lưu trữ cục bộ (trên trình duyệt) các tài nguyên (HTML, CSS, JS, ảnh...) để truy xuất lại nhanh hơn mà không cần tải lại từ server.

### b. Service Worker quản lý cache như thế nào?

Service Worker sử dụng **Cache API** để tạo và quản lý các kho cache (cache storage). Bạn có thể:

- Tạo nhiều "cache" với tên khác nhau (versioning).
- Thêm, xóa, cập nhật, lấy tài nguyên từ cache.
- Chủ động kiểm soát cache cho từng request (theo ý đồ của ứng dụng).

### c. Quy trình cache điển hình

1. **Install:** Khi Service Worker cài đặt lần đầu, nó có thể "pre-cache" các file tĩnh quan trọng (offline HTML, CSS, JS, ảnh...).
2. **Activate:** Có thể xóa cache cũ, cập nhật cache mới nếu cần.
3. **Fetch:** Khi web gửi request, Service Worker sẽ lọc request và quyết định:
   - Trả về từ cache (nếu có).
   - Nếu không có thì fetch từ mạng, sau đó lưu lại vào cache (nếu muốn).
   - Cho phép bạn chọn chiến lược cache phù hợp (cache-first, network-first, stale-while-revalidate...)

**Ví dụ code cache trong Service Worker:**
```javascript
// Sự kiện install: Cache file tĩnh
self.addEventListener('install', event => {
  event.waitUntil(
    caches.open('my-cache-v1').then(cache => {
      return cache.addAll([
        '/',
        '/index.html',
        '/styles.css',
        '/main.js',
      ]);
    })
  );
});

// Sự kiện activate: Xóa cache cũ (nếu có)
self.addEventListener('activate', event => {
  event.waitUntil(
    caches.keys().then(cacheNames => {
      return Promise.all(
        cacheNames.filter(name => name !== 'my-cache-v1')
          .map(name => caches.delete(name))
      );
    })
  );
});

// Sự kiện fetch: Trả về cache nếu có, nếu không thì fetch mạng
self.addEventListener('fetch', event => {
  event.respondWith(
    caches.match(event.request)
      .then(resp => resp || fetch(event.request).then(networkResp => {
        // Lưu lại vào cache cho lần sau
        return caches.open('my-cache-v1').then(cache => {
          cache.put(event.request, networkResp.clone());
          return networkResp;
        });
      }))
  );
});
```
**Giải thích:**  
- Khi cài đặt, Service Worker sẽ cache các file tĩnh cần thiết cho offline.
- Khi fetch, nếu file đã có trong cache thì trả về luôn, nếu chưa thì lấy từ mạng về rồi lưu lại vào cache.
- Khi activate, xóa các cache version cũ để tránh lỗi dữ liệu.

### d. Các chiến lược cache thường gặp

- **Cache First:** Luôn ưu tiên trả về từ cache, nếu không có mới fetch mạng (phù hợp cho file tĩnh).
- **Network First:** Ưu tiên lấy từ mạng, nếu mạng lỗi mới trả về cache (phù hợp cho dữ liệu động).
- **Stale-While-Revalidate:** Trả về cache ngay lập tức, đồng thời fetch mạng để update cache cho lần sau.
- **Cache Only:** Chỉ lấy từ cache, không fetch mạng (dùng cho offline hoàn toàn).

---

## 4. Lưu ý khi sử dụng Service Worker và Cache

- **Cache cần quản lý phiên bản**: Khi update web/app, nên đổi tên cache để tránh lỗi tải file cũ.
- **Cache quá nhiều sẽ chiếm dung lượng browser**: Nên dọn cache cũ, chỉ lưu những file cần thiết.
- **Debug cache bằng DevTools > Application > Cache Storage**.
- **Service Worker chỉ hoạt động trên HTTPS** (trừ localhost).

---

## 5. Một số ứng dụng thực tế

- Tạo Progressive Web App (PWA) cho phép cài lên home screen, offline, push notification.
- Giảm tải server nhờ cache thông minh.
- Tăng trải nghiệm người dùng với web siêu nhanh, hoạt động offline.

---

## 6. Tổng kết

Service Worker là thành phần cốt lõi để xây dựng web hiện đại, đặc biệt là PWA. Cơ chế cache của Service Worker giúp tối ưu hóa hiệu năng, trải nghiệm offline và kiểm soát dữ liệu mà không phụ thuộc hoàn toàn vào server. Hãy tận dụng và quản lý cache đúng cách để web/app của bạn luôn nhanh và ổn định!
