# Gi·ªõi thi·ªáu chi ti·∫øt v·ªÅ Zustand

Zustand l√† m·ªôt th∆∞ vi·ªán qu·∫£n l√Ω tr·∫°ng th√°i (state management) cho React, ƒë∆∞·ª£c t·∫°o ra b·ªüi Poimandres. T√™n "Zustand" trong ti·∫øng ƒê·ª©c c√≥ nghƒ©a l√† "tr·∫°ng th√°i". Tri·∫øt l√Ω c·ªßa n√≥ l√† cung c·∫•p m·ªôt gi·∫£i ph√°p **nh·ªè, nhanh, v√† kh√¥ng r∆∞·ªùm r√†**, gi·∫£i quy·∫øt c√°c v·∫•n ƒë·ªÅ qu·∫£n l√Ω state m√† kh√¥ng c·∫ßn nhi·ªÅu boilerplate code.

---

## T·∫°i sao n√™n ch·ªçn Zustand?

1.  **C·ª±c k·ª≥ ƒë∆°n gi·∫£n:** Kh√¥ng c·∫ßn `Provider` ƒë·ªÉ bao b·ªçc to√†n b·ªô ·ª©ng d·ª•ng. Ch·ªâ c·∫ßn t·∫°o m·ªôt store v√† s·ª≠ d·ª•ng n√≥ nh∆∞ m·ªôt hook.
2.  **√çt Boilerplate:** So v·ªõi Redux, b·∫°n kh√¥ng c·∫ßn ƒë·ªãnh nghƒ©a `actions`, `reducers`, `dispatchers` m·ªôt c√°ch ri√™ng bi·ªát.
3.  **T·ªëi ∆∞u h√≥a Render:** Component s·∫Ω ch·ªâ re-render khi "ph·∫ßn" state m√† n√≥ theo d√µi (subscribe) thay ƒë·ªïi, gi√∫p t·ªëi ∆∞u hi·ªáu nƒÉng.
4.  **H·ªó tr·ª£ Async v√† Middleware:** X·ª≠ l√Ω c√°c t√°c v·ª• b·∫•t ƒë·ªìng b·ªô (nh∆∞ g·ªçi API) r·∫•t tr·ª±c quan. C√≥ s·∫µn middleware cho `persist` (l∆∞u state) v√† `devtools` (t√≠ch h·ª£p Redux DevTools).
5.  **S·ª≠ d·ª•ng ƒë∆∞·ª£c b√™n ngo√†i React:** C√≥ th·ªÉ truy c·∫≠p v√† c·∫≠p nh·∫≠t state t·ª´ c√°c module JavaScript th√¥ng th∆∞·ªùng.

---

## H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng

### 1. C√†i ƒë·∫∑t

```bash
npm install zustand
```

### 2. T·∫°o m·ªôt Store

M·ªôt "store" trong Zustand v·ªÅ c∆° b·∫£n l√† m·ªôt hook, ƒë∆∞·ª£c t·∫°o b·∫±ng h√†m `create`.

```javascript
// src/stores/useCounterStore.js
import { create } from 'zustand';

const useCounterStore = create((set) => ({
  count: 0,
  increment: () => set((state) => ({ count: state.count + 1 })),
  decrement: () => set((state) => ({ count: state.count - 1 })),
  reset: () => set({ count: 0 }),
}));

export default useCounterStore;
```

### 3. S·ª≠ d·ª•ng Store trong Component

Import store v√† g·ªçi n√≥ nh∆∞ m·ªôt hook b√¨nh th∆∞·ªùng.

```jsx
// src/components/Counter.jsx
import useCounterStore from '../stores/useCounterStore';

function Counter() {
  const { count, increment, decrement, reset } = useCounterStore();

  return (
    <div>
      <h1>Count: {count}</h1>
      ...
    </div>
  );
}
```

### 4. T·ªëi ∆∞u h√≥a Render (Selector)

ƒê·ªÉ tr√°nh re-render kh√¥ng c·∫ßn thi·∫øt, b·∫°n c√≥ th·ªÉ truy·ªÅn m·ªôt "selector" ƒë·ªÉ ch·ªâ l·∫•y ph·∫ßn state c·∫ßn thi·∫øt.

```jsx
import useCounterStore from '../stores/useCounterStore';

function DisplayCount() {
  const count = useCounterStore((state) => state.count);
}

function Controls() {
  const increment = useCounterStore((state) => state.increment);
}
```

---

## C√°c Best Practice (Th·ª±c h√†nh t·ªët nh·∫•t)

ƒê·ªÉ s·ª≠ d·ª•ng Zustand hi·ªáu qu·∫£, h√£y tu√¢n theo c√°c nguy√™n t·∫Øc sau:

### 1. Chia nh·ªè Store (Splitting Stores)
**Kh√¥ng t·∫°o m·ªôt store kh·ªïng l·ªì duy nh·∫•t.** Thay v√†o ƒë√≥, h√£y chia state c·ªßa b·∫°n th√†nh c√°c store nh·ªè, logic theo t·ª´ng "domain" ho·∫∑c "feature".

*   **V√≠ d·ª•:** `useUserStore`, `useCartStore`, `useSettingsStore`.
*   **L·ª£i √≠ch:** D·ªÖ qu·∫£n l√Ω, d·ªÖ debug, tƒÉng kh·∫£ nƒÉng t√°i s·ª≠ d·ª•ng v√† gi·∫£m xung ƒë·ªôt khi l√†m vi·ªác nh√≥m.

### 2. S·ª≠ d·ª•ng Selector m·ªôt c√°ch th√¥ng minh
Lu√¥n ch·ªâ "select" nh·ªØng ph·∫ßn state nh·ªè nh·∫•t m√† component c·ªßa b·∫°n c·∫ßn. ƒêi·ªÅu n√†y l√† ch√¨a kh√≥a ƒë·ªÉ t·ªëi ∆∞u hi·ªáu nƒÉng.

```jsx
// T·ªët üëç: Ch·ªâ re-render khi `user.name` thay ƒë·ªïi
const userName = useUserStore(state => state.user.name);

// Kh√¥ng t·ªët üëé: Re-render khi b·∫•t k·ª≥ thu·ªôc t√≠nh n√†o c·ªßa `user` thay ƒë·ªïi
const { user } = useUserStore();
```

**Ch√∫ √Ω khi select nhi·ªÅu gi√° tr·ªã**
H√†m selector state => ({ ... }) **LU√îN LU√îN** t·∫°o ra m·ªôt object **M·ªöI** m·ªói l·∫ßn ch·∫°y => Zustand so s√°nh so s√°nh tham chi·∫øu s·∫Ω nghƒ© l√† object m·ªõi l√†m re-render.

C√≥ th·ªÉ gi·∫£i quy·∫øt b·∫±ng `shallow` ƒë·ªÉ tr√°nh re-render kh√¥ng c·∫ßn thi·∫øt n·∫øu c√°c gi√° tr·ªã kh√¥ng th·ª±c s·ª± thay ƒë·ªïi.

```jsx
// Kh√¥ng t·ªët üëé: Re-render khi ch·∫°y l·∫°i h√†m selector state => ({ username: state.username, email: state.email })
const { username, email } = useUserStore(
  (state) => ({ username: state.username, email: state.email })
);

// T·ªët üëç
const username = useUserStore(state => state.user.username);
const email = useUserStore(state => state.user.email);
//Ho·∫∑c d√πng shallow
import { shallow } from 'zustand/shallow';

// Ch·ªâ re-render khi `username` ho·∫∑c `email` thay ƒë·ªïi
const { username, email } = useUserStore(
  (state) => ({ username: state.username, email: state.email }),
  shallow
);
```

### 3. C·∫≠p nh·∫≠t State ph·ª©c t·∫°p v·ªõi Immer
Khi b·∫°n c·∫ßn c·∫≠p nh·∫≠t c√°c ƒë·ªëi t∆∞·ª£ng l·ªìng nhau (nested objects), vi·ªác s·ª≠ d·ª•ng c√∫ ph√°p spread (`...`) c√≥ th·ªÉ tr·ªü n√™n ph·ª©c t·∫°p. Middleware `immer` gi√∫p b·∫°n vi·∫øt code nh∆∞ th·ªÉ ƒëang thay ƒë·ªïi tr·ª±c ti·∫øp (mutate) state, nh∆∞ng v·∫´n ƒë·∫£m b·∫£o t√≠nh b·∫•t bi·∫øn (immutability).

```bash
npm install immer
```

```javascript
// Kh√¥ng t·ªët üëé
updateName: (newNames) => set(state => (
  {
    ...state, // 1. Sao ch√©p to√†n b·ªô state g·ªëc
    user: {
      ...state.user, // 2. Sao ch√©p object `user`
      profile: {
        ...state.user.profile, // 3. Sao ch√©p object `profile`
        name: 'Jane Doe' // 4. Cu·ªëi c√πng, c·∫≠p nh·∫≠t gi√° tr·ªã `name`
      }
    }
  }
));

// T·ªët üëç
import { create } from 'zustand';
import { immer } from 'zustand/middleware/immer';

const useUserStore = create(
  // B·ªçc h√†m t·∫°o store b·∫±ng middleware `immer`
  immer((set) => ({
    user: {
      profile: {
        name: 'John Doe',
        email: 'john@example.com'
      },
      settings: {
        theme: 'dark'
      }
    },
    posts: [],

    // Action c·∫≠p nh·∫≠t t√™n ng∆∞·ªùi d√πng
    updateName: (newName) => {
      // B√™n trong h√†m set, `state` b√¢y gi·ªù l√† m·ªôt `draft` c·ªßa Immer
      set((state) => {
        // C√∫ ph√°p thay ƒë·ªïi tr·ª±c ti·∫øp, r·∫•t g·ªçn g√†ng!
        state.user.profile.name = newName;
      });
    },
);

export default useUserStore;
```

### 4. T√°ch bi·ªát Actions kh·ªèi State
ƒê·ªÉ l√†m cho c√°c component "c√¢m" (dumber) v√† ch·ªâ t·∫≠p trung v√†o vi·ªác hi·ªÉn th·ªã, b·∫°n c√≥ th·ªÉ t√°ch c√°c actions ra kh·ªèi ƒë·ªãnh nghƒ©a state. ƒêi·ªÅu n√†y c≈©ng gi√∫p c√°c component ch·ªâ s·ª≠ d·ª•ng actions kh√¥ng b·ªã re-render khi state thay ƒë·ªïi.

```javascript
// src/stores/useCartStore.js
const initialState = { items: [], total: 0 };

export const useCartStore = create((set) => ({
  ...initialState,
  // Actions ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a ri√™ng
  addItem: (item) => set(state => ({ items: [...state.items, item] })),
  clearCart: () => set({ items: [], total: 0 }),
}));

// L·∫•y actions ra ƒë·ªÉ s·ª≠ d·ª•ng ·ªü n∆°i kh√°c m√† kh√¥ng c·∫ßn subscribe v√†o state
export const { addItem, clearCart } = useCartStore.getState();
```

### 5. ƒê·∫∑t t√™n Store theo quy ∆∞·ªõc c·ªßa Hook
Lu√¥n b·∫Øt ƒë·∫ßu t√™n store c·ªßa b·∫°n b·∫±ng `use` (v√≠ d·ª•: `useUserStore`). ƒêi·ªÅu n√†y tu√¢n th·ªß quy t·∫Øc c·ªßa React Hooks v√† gi√∫p ESLint c√≥ th·ªÉ b·∫Øt l·ªói n·∫øu b·∫°n s·ª≠ d·ª•ng sai c√°ch.

---

## C√°c t√≠nh nƒÉng n√¢ng cao

### 1. X·ª≠ l√Ω t√°c v·ª• b·∫•t ƒë·ªìng b·ªô (Async)

Vi·∫øt h√†m `async` v√† g·ªçi `set` khi c√≥ k·∫øt qu·∫£.

```javascript
const useUserStore = create((set) => ({
  user: null,
  loading: false,
  fetchUser: async (userId) => {
    set({ loading: true });
    try {
      const response = await fetch(`https://api.example.com/users/${userId}`);
      const user = await response.json();
      set({ user, loading: false });
    } catch (error) {
      set({ loading: false });
    }
  },
}));
```

### 2. Middleware (`devtools` v√† `persist`)

Zustand h·ªó tr·ª£ middleware ƒë·ªÉ m·ªü r·ªông ch·ª©c nƒÉng.

```javascript
import { create } from 'zustand';
import { devtools, persist } from 'zustand/middleware';

const useSettingsStore = create(
  devtools(
    persist(
      (set) => ({
        theme: 'light',
        toggleTheme: () => set((state) => ({ theme: state.theme === 'light' ? 'dark' : 'light' })),
      }),
      {
        name: 'settings-storage', // T√™n key trong localStorage
      }
    )
  )
);
```

---

## So s√°nh nhanh v·ªõi Redux

| T√≠nh nƒÉng | Zustand | Redux (v·ªõi Redux Toolkit) |
| :--- | :--- | :--- |
| **Boilerplate** | R·∫•t √≠t | Kh√° nhi·ªÅu |
| **Provider** | Kh√¥ng c·∫ßn | B·∫Øt bu·ªôc |
| **ƒê·ªô kh√≥** | D·ªÖ | Kh√≥ h∆°n |
| **T·ªëi ∆∞u Render** | T·ª± ƒë·ªông qua selector | C·∫ßn `useSelector` |
| **Async** | T·ª± nhi√™n (`async/await`) | C·∫ßn `createAsyncThunk` |
| **K√≠ch th∆∞·ªõc** | ~1 KB | ~8 KB+ |
