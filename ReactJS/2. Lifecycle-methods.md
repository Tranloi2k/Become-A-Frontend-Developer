# Các phương thức vòng đời (Lifecycle Methods) trong Class Component

### Lifecycle Methods

Trong Class Component, vòng đời được chia thành 3 giai đoạn chính:

1.  **Mounting (Khởi tạo và Gắn vào DOM)**: Component được tạo ra và chèn vào DOM lần đầu tiên.
2.  **Updating (Cập nhật)**: Component được render lại khi có sự thay đổi về `props` hoặc `state`.
3.  **Unmounting (Gỡ khỏi DOM)**: Component bị xóa khỏi DOM.

---

### 1. Giai đoạn Mounting (Khởi tạo)

Các phương thức này được gọi theo thứ tự khi một component được tạo và chèn vào DOM:

#### `constructor()`
*   **Khi nào chạy?** Chạy *đầu tiên*, ngay cả trước khi component được gắn vào DOM.
*   **Mục đích:**
    *   Khởi tạo `state` cho component.
    *   Binding (gán) các phương thức (event handlers).
*   **Lưu ý:** Đây là nơi duy nhất bạn có thể gán `this.state` trực tiếp. Trong tất cả các phương thức khác, bạn phải dùng `this.setState()`.

```javascript
constructor(props) {
  super(props); // Luôn phải gọi super(props) đầu tiên
  this.state = { count: 0 };
  this.handleClick = this.handleClick.bind(this);
}
```

#### `static getDerivedStateFromProps()`
*   **Khi nào chạy?** Chạy ngay trước `render()`, cả trong lần đầu tiên (mounting) và các lần cập nhật sau đó.
*   **Mục đích:** Cho phép component cập nhật `state` dựa trên sự thay đổi của `props`. Đây là một phương thức ít dùng và chỉ nên sử dụng trong các trường hợp đặc biệt.
*   **Lưu ý:** Nó trả về một đối tượng để cập nhật `state`, hoặc `null` nếu không có gì cần thay đổi.

#### `render()`
*   **Khi nào chạy?** Chạy sau `constructor()` (và `getDerivedStateFromProps()` nếu có).
*   **Mục đích:** **Đây là phương thức bắt buộc duy nhất**. Nó đọc `this.props` và `this.state` để trả về các phần tử React (thường là JSX) mô tả giao diện.
*   **Lưu ý:** Phương thức `render()` phải là một hàm "thuần khiết" (pure function), không được thay đổi `state` hoặc tương tác với bên ngoài (như gọi API).

#### `componentDidMount()`
*   **Khi nào chạy?** Chạy *ngay sau khi* component đã được render và gắn vào cây DOM.
*   **Mục đích:** Đây là nơi lý tưởng để thực hiện các tác vụ cần DOM đã sẵn sàng hoặc cần tương tác với bên ngoài.
    *   **Gọi API** để lấy dữ liệu từ server.
    *   Thiết lập các subscription (như `setInterval`, `addEventListener`).
    *   Tương tác trực tiếp với DOM nếu cần.

```javascript
componentDidMount() {
  fetch('https://api.example.com/data')
    .then(response => response.json())
    .then(data => this.setState({ data: data }));
}
```

---

### 2. Giai đoạn Updating (Cập nhật)

Một component sẽ được cập nhật khi `props` hoặc `state` của nó thay đổi. Các phương thức sau được gọi theo thứ tự:

1.  **`static getDerivedStateFromProps()`**: (Như đã giải thích ở trên).

2.  **`shouldComponentUpdate(nextProps, nextState)`**
    *   **Khi nào chạy?** Chạy trước `render()` khi có `props` hoặc `state` mới.
    *   **Mục đích:** Cho phép bạn kiểm soát việc component có nên render lại hay không. Mặc định nó luôn trả về `true`.
    *   **Lưu ý:** Bạn có thể tối ưu hiệu năng bằng cách so sánh `nextProps` với `this.props` và `nextState` với `this.state`. Nếu trả về `false`, quá trình cập nhật sẽ dừng lại (không gọi `render()`, `componentDidUpdate()`).

3.  **`render()`**: (Như đã giải thích ở trên).

4.  **`getSnapshotBeforeUpdate(prevProps, prevState)`**
    *   **Khi nào chạy?** Chạy ngay sau `render()` nhưng *trước khi* kết quả render được commit vào DOM.
    *   **Mục đích:** Cho phép bạn "chụp lại" một số thông tin từ DOM (ví dụ: vị trí cuộn) trước khi nó có thể thay đổi. Giá trị trả về từ phương thức này sẽ được truyền vào `componentDidUpdate()`.

5.  **`componentDidUpdate(prevProps, prevState, snapshot)`**
    *   **Khi nào chạy?** Chạy ngay sau khi component đã được cập nhật và render lại trong DOM.
    *   **Mục đích:** Tương tự `componentDidMount()`, đây là nơi để thực hiện các tác vụ sau khi UI đã được cập nhật.
        *   Gọi API nếu `props` đã thay đổi (cần có điều kiện để tránh lặp vô hạn).
        *   Tương tác với DOM dựa trên kết quả cập nhật.

```javascript
componentDidUpdate(prevProps) {
  // Chỉ gọi API nếu prop 'userId' thay đổi
  if (this.props.userId !== prevProps.userId) {
    this.fetchUserData(this.props.userId);
  }
}
```

---

### 3. Giai đoạn Unmounting (Gỡ bỏ)

Phương thức này được gọi khi một component sắp bị xóa khỏi DOM.

#### `componentWillUnmount()`
*   **Khi nào chạy?** Chạy ngay trước khi component bị gỡ bỏ và phá hủy.
*   **Mục đích:** Đây là nơi để "dọn dẹp" tất cả những gì đã được thiết lập trong `componentDidMount()`.
        *   Hủy các subscription (ví dụ: `clearInterval`, `removeEventListener`).
        *   Hủy các yêu cầu mạng (API calls) chưa hoàn thành.

```javascript
componentWillUnmount() {
  clearInterval(this.myInterval);
  window.removeEventListener('resize', this.handleResize);
}
```

### So sánh với Functional Component (Hooks)

Với sự ra đời của Hooks, các phương thức vòng đời này trong Class Component có thể được ánh xạ sang `useEffect` trong Functional Component:

*   `componentDidMount()` → `useEffect(() => { ... }, [])`
*   `componentDidUpdate()` → `useEffect(() => { ... }, [dependency1, dependency2])`
*   `componentWillUnmount()` → `useEffect(() => { return () => { ... } }, [])`
